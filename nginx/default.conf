server {
    listen 80;

    # Set up the domain configuration (can be localhost in development)
    server_name localhost;

    # Set common proxy headers
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;

    # ------------------------------------
    # 1. API Reverse Proxy (Proxy /api/ to the backend, stripping /api)
    # ------------------------------------
    location /api/ {
        # This crucial step rewrites the URL, so:
        # Request: /api/status 
        # Backend receives: /status
        rewrite ^/api/(.*)$ /$1 break;
        
        # The 'backend' hostname is the service name in docker-compose
        proxy_pass http://backend:5000;
    }

    # ------------------------------------
    # 2. Frontend Proxy (Proxy all other requests to the React Dev Server)
    # ------------------------------------
    location / {
        # For a development server, it's best to proxy directly 
        # and let the React server handle the internal SPA routing,
        # which avoids the NGINX internal redirection cycle error.
        proxy_pass http://frontend:3000;
    }
}
